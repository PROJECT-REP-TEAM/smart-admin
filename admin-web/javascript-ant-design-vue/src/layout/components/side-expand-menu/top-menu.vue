<!--
 * @Author: zhuoda
 * @Date: 2021-08-25 17:09:44
 * @LastEditTime: 2022-06-23
 * @LastEditors: zhuoda
 * @Description:
 * @FilePath: /smart-admin/src/components/side-expand/side-menu/top-menu.vue
-->
<template>
  <div class="top-menu-container">
    <!-- 顶部logo区域 -->
    <div class="logo" @click="goHome">
      <img class="logo-img" :src="logoImg" />
      <div class="title">SmartAdmin 2.X</div>
    </div>
    <!-- 一级菜单展示 -->
    <a-menu :selectedKeys="selectedKeys" mode="inline" :theme="theme">
      <template v-for="item in props.menuTree" :key="item.menuId">
        <template v-if="item.visibleFlag">
          <a-menu-item :key="item.menuId.toString()" @click="selectMenu(item)">
            <template #icon>
              <component :is="$antIcons[item.icon]" />
            </template>
            {{ item.menuName }}
          </a-menu-item>
        </template>
      </template>
    </a-menu>
  </div>
</template>
<script setup>
import _ from "lodash";
import { computed, ref, watch } from "vue";
import { useRoute } from "vue-router";
import { MENU_TYPE_ENUM } from "/@/constants/system/menu-const";
import { router } from "/@/router";
import { useUserStore } from "/@/store/modules/system/user";
import { useAppConfigStore } from "/@/store/modules/system/app-config";
import { HOME_PAGE_NAME } from "/@/constants/system/home-const";
import logoImg from "/@/assets/images/logo/smart-admin-logo.png";

const theme = computed(() => useAppConfigStore().$state.sideMenuTheme);

const props = defineProps({
  menuTree: Array,
});
const selectedMenu = ref();
let currentRoute = useRoute();

const parentMenuList = computed(() => {
  let currentName = currentRoute.name;
  if (!currentName || typeof currentName !== "string") {
    return [];
  }
  let menuParentIdListMap = useUserStore().getMenuParentIdListMap;
  return menuParentIdListMap.get(currentName) || [];
});

const selectedKeys = computed(() => {
  if (selectedMenu.value) {
    return [selectedMenu.value.menuId.toString()];
  }
  return parentMenuList.value.map((e) => e.name);
});
watch(
  currentRoute,
  () => {
    selectedMenu.value = undefined;
    let menuList = props.menuTree.map((e) => e.menuId.toString());
    let parentIdList = _.intersection(menuList, selectedKeys.value);
    if (parentIdList.length > 0) {
      let parentId = parentIdList[0];
      let parentItem = props.menuTree.find((e) => e.menuId == Number(parentId));
      selectedMenu.value = parentItem;
    }
  },
  {
    immediate: true,
  }
);
// 页面跳转
function selectMenu(route) {
  selectedMenu.value = route;
  if (
    route.menuType == MENU_TYPE_ENUM.MENU.value &&
    (_.isEmpty(route.children) || route.children.every((e) => !e.visibleFlag))
  ) {
    router.push({ name: route.menuId.toString() });
  }
}
function goHome() {
  router.push({ name: HOME_PAGE_NAME });
}
defineExpose({
  selectedMenu,
});
</script>
<style scoped lang="less">
.top-menu-container {
  height: 100%;
}
.logo {
  height: @header-user-height;
  line-height: @header-user-height;
  padding: 0px 15px 0px 15px;
  width: 100%;
  z-index: 9999;
  display: flex;
  justify-content: space-between;
  cursor: pointer;

  .logo-img {
    width: 40px;
    height: 40px;
  }

  .title {
    font-size: 16px;
    font-weight: 600;
    overflow: hidden;
    color: v-bind('theme === "light" ? "#001529": "#ffffff"');
  }
}
</style>
